name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download macOS DMGs and calculate SHA256
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Download ARM64 DMG
          curl -sLO "https://github.com/behnamazimi/zoyla/releases/download/v${VERSION}/zoyla-${VERSION}-macos-arm64.dmg"
          ARM64_SHA=$(shasum -a 256 "zoyla-${VERSION}-macos-arm64.dmg" | cut -d' ' -f1)
          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_OUTPUT
          
          # Download x64 DMG
          curl -sLO "https://github.com/behnamazimi/zoyla/releases/download/v${VERSION}/zoyla-${VERSION}-macos-x64.dmg"
          X64_SHA=$(shasum -a 256 "zoyla-${VERSION}-macos-x64.dmg" | cut -d' ' -f1)
          echo "X64_SHA=$X64_SHA" >> $GITHUB_OUTPUT
          
          echo "ARM64 SHA256: $ARM64_SHA"
          echo "X64 SHA256: $X64_SHA"

      - name: Checkout homebrew-zoyla
        uses: actions/checkout@v4
        with:
          repository: behnamazimi/homebrew-zoyla
          token: ${{ secrets.PAT_GITHUB }}
          path: homebrew-zoyla

      - name: Update cask formula
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARM64_SHA="${{ steps.sha256.outputs.ARM64_SHA }}"
          X64_SHA="${{ steps.sha256.outputs.X64_SHA }}"
          
          cat > homebrew-zoyla/Casks/zoyla.rb << EOF
          cask "zoyla" do
            version "$VERSION"

            on_intel do
              sha256 "$X64_SHA"
              url "https://github.com/behnamazimi/zoyla/releases/download/v#{version}/zoyla-#{version}-macos-x64.dmg"
            end

            on_arm do
              sha256 "$ARM64_SHA"
              url "https://github.com/behnamazimi/zoyla/releases/download/v#{version}/zoyla-#{version}-macos-arm64.dmg"
            end

            name "Zoyla"
            desc "Fast, lightweight HTTP load testing desktop application"
            homepage "https://github.com/behnamazimi/zoyla"

            app "zoyla.app"

            caveats <<~EOS
              Zoyla is not signed with an Apple Developer certificate.
              If you see "zoyla is damaged and can't be opened", run:
                xattr -cr /Applications/zoyla.app
            EOS
          end
          EOF

      - name: Commit and push changes
        working-directory: homebrew-zoyla
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/zoyla.rb
          git commit -m "Update zoyla to v${VERSION}"
          git push

