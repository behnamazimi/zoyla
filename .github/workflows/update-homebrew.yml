name: Update Homebrew Tap

on:
  # Auto-trigger when release assets are uploaded/edited
  release:
    types: [edited]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Check if macOS DMGs exist
        id: check
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Check ARM64 DMG
          ARM64_STATUS=$(curl -sI "https://github.com/behnamazimi/zoyla/releases/download/v${VERSION}/zoyla-${VERSION}-macos-arm64.dmg" | head -1 | grep -o "[0-9][0-9][0-9]" | head -1)
          
          # Check x64 DMG
          X64_STATUS=$(curl -sI "https://github.com/behnamazimi/zoyla/releases/download/v${VERSION}/zoyla-${VERSION}-macos-x64.dmg" | head -1 | grep -o "[0-9][0-9][0-9]" | head -1)
          
          echo "ARM64 status: $ARM64_STATUS"
          echo "X64 status: $X64_STATUS"
          
          if [ "$ARM64_STATUS" = "302" ] && [ "$X64_STATUS" = "302" ]; then
            echo "BOTH_EXIST=true" >> $GITHUB_OUTPUT
            echo "✓ Both macOS DMGs found"
          else
            echo "BOTH_EXIST=false" >> $GITHUB_OUTPUT
            echo "⚠ Missing macOS DMGs - skipping Homebrew update"
          fi

      - name: Download macOS DMGs and calculate SHA256
        if: steps.check.outputs.BOTH_EXIST == 'true'
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Download ARM64 DMG
          curl -sLO "https://github.com/behnamazimi/zoyla/releases/download/v${VERSION}/zoyla-${VERSION}-macos-arm64.dmg"
          ARM64_SHA=$(shasum -a 256 "zoyla-${VERSION}-macos-arm64.dmg" | cut -d' ' -f1)
          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_OUTPUT
          
          # Download x64 DMG
          curl -sLO "https://github.com/behnamazimi/zoyla/releases/download/v${VERSION}/zoyla-${VERSION}-macos-x64.dmg"
          X64_SHA=$(shasum -a 256 "zoyla-${VERSION}-macos-x64.dmg" | cut -d' ' -f1)
          echo "X64_SHA=$X64_SHA" >> $GITHUB_OUTPUT
          
          echo "ARM64 SHA256: $ARM64_SHA"
          echo "X64 SHA256: $X64_SHA"

      - name: Checkout homebrew-zoyla
        if: steps.check.outputs.BOTH_EXIST == 'true'
        uses: actions/checkout@v4
        with:
          repository: behnamazimi/homebrew-zoyla
          token: ${{ secrets.PAT_GITHUB }}
          path: homebrew-zoyla

      - name: Update cask formula
        if: steps.check.outputs.BOTH_EXIST == 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARM64_SHA="${{ steps.sha256.outputs.ARM64_SHA }}"
          X64_SHA="${{ steps.sha256.outputs.X64_SHA }}"
          
          cat > homebrew-zoyla/Casks/zoyla.rb << 'CASKEOF'
          cask "zoyla" do
            version "VERSION_PLACEHOLDER"

            on_intel do
              sha256 "X64_SHA_PLACEHOLDER"
              url "https://github.com/behnamazimi/zoyla/releases/download/v#{version}/zoyla-#{version}-macos-x64.dmg"
            end

            on_arm do
              sha256 "ARM64_SHA_PLACEHOLDER"
              url "https://github.com/behnamazimi/zoyla/releases/download/v#{version}/zoyla-#{version}-macos-arm64.dmg"
            end

            name "Zoyla"
            desc "Fast, lightweight HTTP load testing desktop application"
            homepage "https://github.com/behnamazimi/zoyla"

            app "zoyla.app"
          end
          CASKEOF
          
          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" homebrew-zoyla/Casks/zoyla.rb
          sed -i "s/X64_SHA_PLACEHOLDER/$X64_SHA/g" homebrew-zoyla/Casks/zoyla.rb
          sed -i "s/ARM64_SHA_PLACEHOLDER/$ARM64_SHA/g" homebrew-zoyla/Casks/zoyla.rb

      - name: Commit and push changes
        if: steps.check.outputs.BOTH_EXIST == 'true'
        working-directory: homebrew-zoyla
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/zoyla.rb
          git commit -m "Update zoyla to v${VERSION}"
          git push

