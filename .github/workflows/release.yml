name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            arch: 'x64'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            arch: 'arm64'
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            arch: 'x64'
          - platform: 'ubuntu-22.04-arm'
            target: 'aarch64-unknown-linux-gnu'
            arch: 'arm64'

    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Linux only)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            xdg-utils

      - name: Install frontend dependencies
        run: npm ci

      - name: Import Apple Developer Certificate (macOS only)
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Build the app (macOS with signing, no notarization)
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # Notarization requires APPLE_ID, APPLE_PASSWORD, and APPLE_TEAM_ID.
          # Tauri auto-notarizes when all three are set. Omitting them skips notarization
          # while still signing the app. Uncomment below to enable notarization:
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Build the app (non-macOS)
        if: matrix.platform != 'macos-latest'
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Cleanup keychain (macOS only)
        if: matrix.platform == 'macos-latest' && always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain $KEYCHAIN_PATH
          fi

      - name: Extract version from package.json
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Prepare Windows artifacts
        if: matrix.platform == 'windows-latest'
        shell: bash
        run: |
          mkdir -p dist-artifacts
          VERSION="${{ steps.version.outputs.VERSION }}"
          # Copy and rename MSI
          if [ -f "src-tauri/target/${{ matrix.target }}/release/bundle/msi"/*.msi ]; then
            cp src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi "dist-artifacts/zoyla-${VERSION}-windows-x64.msi"
          fi
          # Copy and rename NSIS installer
          if [ -f "src-tauri/target/${{ matrix.target }}/release/bundle/nsis"/*.exe ]; then
            cp src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe "dist-artifacts/zoyla-${VERSION}-windows-x64-setup.exe"
          fi

      - name: Prepare macOS artifacts
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          mkdir -p dist-artifacts
          VERSION="${{ steps.version.outputs.VERSION }}"
          OS_ARCH="${{ matrix.target == 'aarch64-apple-darwin' && 'macos-arm64' || 'macos-x64' }}"
          # Copy and rename .dmg file
          if [ -f "src-tauri/target/${{ matrix.target }}/release/bundle/dmg"/*.dmg ]; then
            cp src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg "dist-artifacts/zoyla-${VERSION}-${OS_ARCH}.dmg"
          fi

      - name: Prepare Linux artifacts
        if: startsWith(matrix.platform, 'ubuntu')
        shell: bash
        run: |
          mkdir -p dist-artifacts
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCH="${{ matrix.arch }}"
          # Copy and rename AppImage
          if ls src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage 1> /dev/null 2>&1; then
            cp src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage "dist-artifacts/zoyla-${VERSION}-linux-${ARCH}.AppImage"
          fi
          # Copy and rename .deb
          if ls src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb 1> /dev/null 2>&1; then
            cp src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb "dist-artifacts/zoyla-${VERSION}-linux-${ARCH}.deb"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zoyla-${{ matrix.target }}
          path: dist-artifacts/*
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Find and list release files
        shell: bash
        run: |
          echo "Release files:"
          find artifacts -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.app" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" \) | head -20

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.exe
            artifacts/**/*.msi
            artifacts/**/*.dmg
            artifacts/**/*.AppImage
            artifacts/**/*.deb
          name: Release ${{ steps.tag_version.outputs.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

